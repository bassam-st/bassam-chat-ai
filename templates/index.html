<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Bassam Chat AI (Gemini)</title>
  <link rel="stylesheet" href="/static/style.css"/>
</head>
<body>
  <main class="container">
    <h1>Bassam Chat AI (Gemini) ğŸ¤–</h1>
    <p>Ø§Ù„Ù…Ø¹Ø±ÙØ© Ø§Ù„Ù…Ø®Ø²Ù†Ø©: <b id="doc-count">{{ doc_count }}</b> Ù…Ø³ØªÙ†Ø¯</p>

    <section class="kb">
      <h2>â• Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø±ÙØ© (ØªØ¯Ø®Ù„ ÙÙŠ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¯Ù„Ø§Ù„ÙŠ)</h2>
      <form id="kb-form">
        <input name="title" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø³ØªÙ†Ø¯" required />
        <textarea name="content" rows="6" placeholder="Ø£Ù„ØµÙ‚ Ù†ØµÙ‹Ø§ Ø£Ùˆ Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙƒ Ù‡Ù†Ø§" required></textarea>
        <button type="submit">Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…Ø®Ø²Ù†</button>
        <span id="kb-status"></span>
      </form>
    </section>

    <section class="chat">
      <h2>ğŸ’¬ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</h2>
      <label><input type="checkbox" id="use-search" checked /> Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¯Ù„Ø§Ù„ÙŠ</label>
      <div id="chat-box" class="chat-box"></div>
      <form id="chat-form">
        <input id="msg" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ù‡Ù†Ø§..." autocomplete="off" />
        <button>Ø¥Ø±Ø³Ø§Ù„</button>
      </form>
    </section>
  </main>

<script>
const $ = s => document.querySelector(s);

$("#kb-form").addEventListener("submit", async (e) => {
  e.preventDefault();
  const fd = new FormData(e.target);
  $("#kb-status").textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø¶Ø§ÙØ©...";
  const res = await fetch("/upload", { method: "POST", body: fd });
  const ok = (await res.json()).ok;
  $("#kb-status").textContent = ok ? "âœ“ ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©" : "Ø­Ø¯Ø« Ø®Ø·Ø£";
  // Ø¹Ø¯Ù‘Ø§Ø¯ ØªÙ‚Ø±ÙŠØ¨ÙŠ
  const c = $("#doc-count"); c.textContent = (parseInt(c.textContent||"0")+1);
  e.target.reset();
});

$("#chat-form").addEventListener("submit", async (e) => {
  e.preventDefault();
  const message = $("#msg").value.trim();
  if (!message) return;
  $("#msg").value = "";
  const bubble = document.createElement("div");
  bubble.className = "bubble user";
  bubble.textContent = message;
  $("#chat-box").appendChild(bubble);

  const bot = document.createElement("div");
  bot.className = "bubble bot";
  $("#chat-box").appendChild(bot);

  const res = await fetch("/chat", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ message, use_search: $("#use-search").checked })
  });

  const reader = res.body.getReader();
  const decoder = new TextDecoder();
  while (true) {
    const {value, done} = await reader.read();
    if (done) break;
    bot.textContent += decoder.decode(value, {stream:true});
    $("#chat-box").scrollTop = $("#chat-box").scrollHeight;
  }
});
</script>
</body>
</html>
