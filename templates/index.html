<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Bassam Chat AI (Gemini)</title>
  <link rel="stylesheet" href="/static/style.css"/>
</head>
<body>
  <main class="container">
    <h1>Bassam Chat AI (Gemini) 🤖</h1>
    <p>المعرفة المخزنة: <b id="doc-count">{{ doc_count }}</b> مستند</p>

    <section class="kb">
      <h2>➕ إضافة معرفة (تدخل في البحث الدلالي)</h2>
      <form id="kb-form">
        <input name="title" placeholder="عنوان المستند" required />
        <textarea name="content" rows="6" placeholder="ألصق نصًا أو ملاحظاتك هنا" required></textarea>
        <button type="submit">إضافة للمخزن</button>
        <span id="kb-status"></span>
      </form>
    </section>

    <section class="chat">
      <h2>💬 المحادثة</h2>
      <label><input type="checkbox" id="use-search" checked /> استخدم البحث الدلالي</label>
      <div id="chat-box" class="chat-box"></div>
      <form id="chat-form">
        <input id="msg" placeholder="اكتب سؤالك هنا..." autocomplete="off" />
        <button>إرسال</button>
      </form>
    </section>
  </main>

<script>
const $ = s => document.querySelector(s);

$("#kb-form").addEventListener("submit", async (e) => {
  e.preventDefault();
  const fd = new FormData(e.target);
  $("#kb-status").textContent = "جاري الإضافة...";
  const res = await fetch("/upload", { method: "POST", body: fd });
  const ok = (await res.json()).ok;
  $("#kb-status").textContent = ok ? "✓ تمت الإضافة" : "حدث خطأ";
  // عدّاد تقريبي
  const c = $("#doc-count"); c.textContent = (parseInt(c.textContent||"0")+1);
  e.target.reset();
});

$("#chat-form").addEventListener("submit", async (e) => {
  e.preventDefault();
  const message = $("#msg").value.trim();
  if (!message) return;
  $("#msg").value = "";
  const bubble = document.createElement("div");
  bubble.className = "bubble user";
  bubble.textContent = message;
  $("#chat-box").appendChild(bubble);

  const bot = document.createElement("div");
  bot.className = "bubble bot";
  $("#chat-box").appendChild(bot);

  const res = await fetch("/chat", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ message, use_search: $("#use-search").checked })
  });

  const reader = res.body.getReader();
  const decoder = new TextDecoder();
  while (true) {
    const {value, done} = await reader.read();
    if (done) break;
    bot.textContent += decoder.decode(value, {stream:true});
    $("#chat-box").scrollTop = $("#chat-box").scrollHeight;
  }
});
</script>
</body>
</html>
