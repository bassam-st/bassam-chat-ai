<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ุจุณุงู โ ูุญุงุฏุซุงุช ุจุฎููุท + ูุนู ูุชุงุจุนุฉ</title>

  <meta name="theme-color" content="#7c3aed"/>
  <link rel="manifest" href="/static/pwa/manifest.json"/>
  <link rel="apple-touch-icon" href="/static/icons/icon-192.png"/>
  <link rel="stylesheet" href="/static/style.css"/>
</head>
<body>
<div class="wrap">
  <div class="header">
    <h1>ุจุณุงู โ ูุญุงุฏุซุงุช ุจุฎููุท + ูุนู ูุชุงุจุนุฉ</h1>
    <form action="/thread/new" method="post">
      <button class="btn" type="submit">โ ูุญุงุฏุซุฉ ุฌุฏูุฏุฉ</button>
    </form>
  </div>

  <div class="layout">
    <!-- ูุงุฆูุฉ ุงููุญุงุฏุซุงุช -->
    <aside class="card">
      <h3>ุงููุญุงุฏุซุงุช</h3>
      <ul>
        {% for th in threads %}
        <li>
          <a class="thread {% if th.id==cur %}active{% endif %}" href="/?t={{ th.id }}">
            #{{ th.id }} โ {{ th.title or "ุจุฏูู ุนููุงู" }}
            <div class="ts">{{ th.created_at }}</div>
          </a>
        </li>
        {% endfor %}
      </ul>
      <hr class="hr">

      <form action="/thread/rename" method="post" class="row">
        <input type="hidden" name="tid" value="{{ cur }}"/>
        <input type="text" name="title" placeholder="ุงุณู ุงูุฎูุทโฆ"/>
        <button class="btn" type="submit">ุญูุธ ุงูุงุณู</button>
      </form>
    </aside>

    <!-- ูุณุงุญุฉ ุงูุฏุฑุฏุดุฉ -->
    <main class="card">
      <div id="chat">
        {% for m in msgs %}
          <div class="msg {{ m.role }}">
            <span class="ts">{{ m.ts }}</span>{{ m.text }}
          </div>
        {% endfor %}
      </div>

      <form class="row" onsubmit="return sendMsg()">
        <input id="q" type="text" placeholder="ุงูุชุจ ุณุคุงูู ููุงโฆ" required/>
        <button class="btn" type="submit">ุงุณุฃู</button>
      </form>
    </main>
  </div>

  <div class="footer">ยฉ Bassam 2025 โ ูุนู ูุชุงุจุนุฉ + ุจุญุซ ูุฌุงูู.</div>
</div>

<!-- ุฒุฑ ุงูุชุซุจูุช (PWA) + ุงูุชุณุฌูู ููุฎุฏูุฉ -->
<script>
let deferredPrompt=null;
window.addEventListener("beforeinstallprompt",(e)=>{
  e.preventDefault(); deferredPrompt=e;
  const b=document.createElement("button");
  b.className="install"; b.textContent="๐ฑ ุชุซุจูุช";
  b.onclick=async()=>{ b.style.display="none"; deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt=null; };
  document.body.appendChild(b);
});
if("serviceWorker" in navigator){ navigator.serviceWorker.register("/sw.js").catch(()=>{}); }

const tid={{ cur|int }};
const chat=document.getElementById('chat');
const q=document.getElementById('q');

function addMsg(txt,who){
  const d=document.createElement('div');
  d.className='msg '+who;
  const ts=document.createElement('span');
  ts.className='ts';
  ts.textContent=new Date().toISOString();
  d.appendChild(ts);
  d.appendChild(document.createTextNode("\n"+txt));
  chat.appendChild(d);
  chat.scrollTop=chat.scrollHeight;
}

async function sendMsg(){
  const text=q.value.trim(); if(!text) return false;
  addMsg(text,'user'); q.value='';
  const url=`/api/ask_sse?q=${encodeURIComponent(text)}&tid=${tid}`;
  const es=new EventSource(url);
  let buf='';

  const holder=document.createElement('div');
  holder.className='msg assistant';
  const ts=document.createElement('span'); ts.className='ts'; ts.textContent=new Date().toISOString();
  holder.appendChild(ts);
  const tn=document.createTextNode('...'); holder.appendChild(tn);
  chat.appendChild(holder);

  es.onmessage=(e)=>{
    const d=JSON.parse(e.data);
    if(d.chunk){ buf+=d.chunk; holder.childNodes[1].nodeValue="\n"+buf; chat.scrollTop=chat.scrollHeight; }
    if(d.done){ es.close(); }
  };
  es.onerror=()=>{ es.close(); };
  return false;
}
</script>
</body>
</html>
