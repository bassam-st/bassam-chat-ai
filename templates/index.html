<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Bassam Chat AI (Gemini)</title>
  <link rel="stylesheet" href="/static/style.css"/>
</head>
<body>
  <header>
    <h1>Bassam Chat AI (Gemini) ๐ค</h1>
    <p class="sub">ูุฏุนู ุงูุจุญุซ ุงูุฏูุงูู ูู ูุฎุฒู ุงููุนุฑูุฉ + ุฏุฑุฏุดุฉ ุนุฑุจูุฉ ููุฑูุฉ.</p>
  </header>

  <!-- ูุณู ุงูุชุบุฐูุฉ ุงููุฏููุฉ (ูุต/ููู ูุงุญุฏ) -->
  <section class="panel">
    <h3>ุงููุฎุฒู ุงูุฏูุงูู (RAG) - ุฅุถุงูุฉ ูุต ุฃู ููู ูุงุญุฏ</h3>

    <label>ุฃูุตู ูุตูุง ููุง:</label>
    <textarea id="kb-text" rows="7" placeholder="ุฃูุตู ูุตูุง ุฃู ููุฎุตูุง ุฃู ููุงูุฉ..."></textarea>

    <div class="row">
      <input id="kb-title" placeholder="ุนููุงู ุงุฎุชูุงุฑู"/>
      <input type="file" id="kb-file" />
    </div>

    <button id="btn-add">ุฅุถุงูุฉ ูููุฎุฒู</button>
    <div id="kb-status" class="status-line"></div>
  </section>

  <!-- ูุณู ุงูุชุบุฐูุฉ ุงูุดุงููุฉ (ZIP ูุงูู) -->
  <section class="panel">
    <h3>ุฅุฏุฎุงู ุญุฒูุฉ ูุนุฑูุฉ ูุงููุฉ (ZIP)</h3>

    <p class="sub">
      ุงุฎุชูุฑ ููู ZIP ูุงูู (ูุซูุงู ai_knowledge_pack.zip).  
      ูู ุงููููุงุช ุงููุตูุฉ ุฏุงุฎูู (.md .txt ุงูุฎ...) ุณูุชู ุชุญููููุง ูุชุฎุฒูููุง ูู ูุงุนุฏุฉ ุงููุนุฑูุฉ ุงูุฏุงุฎููุฉ.
      ุจุนุฏ ุงูููุฑุณุฉุ ุงููุณุงุนุฏ ููุฏุฑ ูุณุชุฎุฏู ูุฐู ุงููุนุฑูุฉ ูู ุงูุฅุฌุงุจุฉ.
    </p>

    <div class="row">
      <input type="file" id="kb-zip" />
    </div>

    <button id="btn-zip">ููุฑุณุฉ ZIP ุจุงููุงูู</button>

    <div id="zip-status" class="status-line" style="margin-top:8px;"></div>
  </section>

  <!-- ูุณู ุงููุญุงุฏุซุฉ -->
  <section class="panel">
    <h3>ุงููุญุงุฏุซุฉ ๐ฌ</h3>

    <label class="chk">
      <input type="checkbox" id="use-search" checked />
      <span>ุงุณุชุฎุฏู ุงูุจุญุซ ุงูุฏูุงูู (ุงููุนุฑูุฉ ุงูุฏุงุฎููุฉ)</span>
    </label>

    <div id="chat"></div>

    <div class="row">
      <input id="msg" placeholder="ุงูุชุจ ุณุคุงูู ููุง..." />
      <button id="send">ุฅุฑุณุงู</button>
    </div>
  </section>

  <footer>
    <small>ุจููู ุจุงุณุชุฎุฏุงู FastAPI + Gemini. ุงูุชุฎุฒูู ูู /tmp ุฃู data.db (ูุฏ ูุง ูููู ุฏุงุฆู ุนูู ุงูุฎุทุฉ ุงููุฌุงููุฉ).</small>
  </footer>

<script>
const $ = (sel) => document.querySelector(sel);

// ุฏุงูุฉ ูุนุฑุถ ููุงุนุฉ ุฏุฑุฏุดุฉ
function addBubble(text, who="bot"){
  const div = document.createElement("div");
  div.className = "bubble " + who;
  div.textContent = text;
  $("#chat").appendChild(div);
  $("#chat").scrollTop = $("#chat").scrollHeight;
}

// ุฒุฑ ุฅุถุงูุฉ ูุต / ููู ูุงุญุฏ ุฅูู ูุงุนุฏุฉ ุงููุนุฑูุฉ
$("#btn-add").onclick = async () => {
  const text = $("#kb-text").value.trim();
  const title = $("#kb-title").value.trim();
  const file = $("#kb-file").files[0];

  const fd = new FormData();
  if (title) fd.append("title", title);
  if (text) fd.append("text", text);
  if (file) fd.append("file", file);

  $("#kb-status").textContent = "โณ ุฌุงุฑู ุงูุฅุถุงูุฉ...";
  try {
    const res = await fetch("/upload", { method: "POST", body: fd });
    const data = await res.json();
    if (data.ok) {
      $("#kb-status").textContent = `โ๏ธ ุชู ุงูุญูุธ: ${data.title} (${data.chars} ุญุฑู)`;
      $("#kb-text").value = "";
      $("#kb-title").value = "";
      $("#kb-file").value = "";
    } else {
      $("#kb-status").textContent = "โ " + (data.error || "ูุดู ุบูุฑ ูุนุฑูู");
    }
  } catch (e) {
    $("#kb-status").textContent = "โ ุฎุทุฃ ูู ุงูุดุจูุฉ";
  }
};

// ุฒุฑ ููุฑุณุฉ ZIP ูุงูู (ุชุบุฐูุฉ ุถุฎูุฉ)
$("#btn-zip").onclick = async () => {
  const zipFile = $("#kb-zip").files[0];
  if (!zipFile) {
    $("#zip-status").textContent = "โ ุงุฎุชุฑ ููู ZIP ุฃููุงู";
    return;
  }

  const fd = new FormData();
  // ููู: ูุฌุจ ุฃู ูููู ุงูุญูู ุงุณูู "file" ูุฃู ุงูุจุงู ุฅูุฏ ูุณุชูุจูู ุจูุฐุง ุงูุงุณู
  fd.append("file", zipFile);

  $("#zip-status").textContent = "โณ ุฌุงุฑู ุงูููุฑุณุฉ...";
  try {
    const res = await fetch("/ingest-zip", {
      method: "POST",
      body: fd
    });
    const data = await res.json();

    if (data.ok) {
      // backend ูุฑุฌุน message ูุซู: "ุชู ููุฑุณุฉ 9 ููููุง ู 120 ููุทุน."
      $("#zip-status").textContent = "โ๏ธ " + data.message;
      $("#kb-zip").value = "";
    } else {
      $("#zip-status").textContent = "โ " + (data.message || "ูุดู ุบูุฑ ูุนุฑูู");
    }
  } catch (e) {
    $("#zip-status").textContent = "โ ูุดููุฉ ุงุชุตุงู";
  }
};

// ุฅุฑุณุงู ุฑุณุงูุฉ ูููุณุงุนุฏ ููุฑุงุกุฉ ุงูุฑุฏ
$("#send").onclick = async () => {
  const msg = $("#msg").value.trim();
  if (!msg) return;

  // ุฃุถู ุฑุณุงูุฉ ุงููุณุชุฎุฏู ูู ุงูุดุงุช
  addBubble(msg, "user");
  $("#msg").value = "";

  // ุฃุถู ููุงุนุฉ ุงูุชุธุงุฑ ุงูุฑุฏ
  addBubble("โฆ ูุฌุฑู ุงูุชูููุฑ โฆ", "bot");

  try {
    const res = await fetch("/chat", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({
        message: msg,
        use_search: $("#use-search").checked
      })
    });

    const data = await res.json();
    const last = document.querySelector("#chat .bubble.bot:last-child");
    last.textContent = data.reply || data.error || "โ ุญุฏุซ ุฎุทุฃ ูู ุงูุฎุงุฏู";
  } catch (e) {
    const last = document.querySelector("#chat .bubble.bot:last-child");
    last.textContent = "โ ูุดููุฉ ุงุชุตุงู";
  }
};

// ุฅุฑุณุงู ุจุงูุฅูุชุฑ
$("#msg").addEventListener("keydown", (e)=>{
  if (e.key === "Enter") $("#send").click();
});
</script>
</body>
</html>
